(()=>{"use strict";window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t&&t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t&&t())},makeElement:(e,t,n)=>{let o=document.createElement(e);return o.classList.add(t),n&&(o.textContent=n),o},getRandomFromInterval:(e,t)=>{let n=Math.ceil(e),o=Math.floor(t);return Math.floor(Math.random()*(o-n+1)+n)},getRandomizedArray:e=>{let t=[],n=e.slice();for(let o=e.length-1;o>=0;o--)t.push(n.splice(window.utils.getRandomFromInterval(0,o),1)[0]);return t},debounce:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}}},window.nodes={body:document.querySelector("body"),imgEditingForm:document.querySelector(".img-upload__form"),uploadFileInput:document.querySelector("#upload-file"),imgEditingFormComment:document.querySelector(".text__description"),textHashtagsInput:document.querySelector(".text__hashtags"),picturesList:document.querySelector(".pictures"),bigPicture:document.querySelector(".big-picture"),filterSliderControl:document.querySelector(".effect-level__pin")},(()=>{const e={LOAD:"https://21.javascript.pages.academy/kekstagram/data",SAVE:"https://21.javascript.pages.academy/kekstagram"},t={LOAD:"GET",SAVE:"POST"},n="LOAD",o="SAVE",i=(n,o,i,d)=>{let r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200!==r.status?i():o(r.response)})),r.addEventListener("error",i),r.addEventListener("timeout",i),r.timeout=1e4,r.open(t[n],e[n]),d?r.send(d):r.send()};window.backend={load:(e,t)=>{i(n,e,t)},save:(e,t,n)=>{i(o,t,n,e)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");let t=0;window.picture={updateGallery:n=>{const o=document.createDocumentFragment();let i=n.length<25?n.length:25;for(let e=0;e<t;e++)window.nodes.picturesList.querySelector(".picture").remove();n.slice(0,i).forEach(((t,n)=>{o.appendChild(((e,t,n)=>{let o=n.cloneNode(!0);return o.dataset.imgNumber=t,o.querySelector(".picture__img").src=e.url,o.querySelector(".picture__likes").textContent=e.likes,o.querySelector(".picture__comments").textContent=e.comments.length,o})(t,n,e))})),window.nodes.picturesList.appendChild(o),t=i}}})(),(()=>{const e=window.nodes.bigPicture.querySelector(".big-picture__cancel"),t=window.nodes.bigPicture.querySelector(".comments-count__shown"),n=window.nodes.bigPicture.querySelector(".comments-count"),o=window.nodes.bigPicture.querySelector(".social__comments"),i=window.nodes.bigPicture.querySelector(".comments-loader");let d=()=>{};const r=()=>{d()},s=()=>{window.preview.closeBigPicture()},l=e=>{window.utils.isEscEvent(e,window.preview.closeBigPicture)};window.preview={openBigPicture:a=>{window.nodes.body.classList.add("modal-open"),window.nodes.bigPicture.classList.remove("hidden"),(e=>{window.nodes.bigPicture.querySelector(".big-picture__img").querySelector("img").src=e.url,window.nodes.bigPicture.querySelector(".likes-count").textContent=e.likes,window.nodes.bigPicture.querySelector(".social__caption").textContent=e.description;let s=e.comments;o.innerHTML="",i.classList.remove("hidden");let l=0;const a=e=>{let t=window.utils.makeElement("li","social__comment"),n=window.utils.makeElement("img","social__picture");n.src=e.avatar,n.alt=e.name,n.width=35,n.height=35,t.appendChild(n);let o=window.utils.makeElement("p","social__text",e.message);return t.appendChild(o),t};d=()=>{let e=s.length-l,d=5<e?5:e;for(let e=0;e<d;e++)o.appendChild(a(s[l+e]));l+=d,t.textContent=l,n.textContent=s.length,l===s.length&&(i.classList.add("hidden"),i.removeEventListener("click",r))},d(),i.addEventListener("click",r)})(a),e.addEventListener("click",s),document.addEventListener("keydown",l)},closeBigPicture:()=>{window.nodes.body.classList.remove("modal-open"),window.nodes.bigPicture.classList.add("hidden"),e.removeEventListener("click",s),document.removeEventListener("keydown",l),i.removeEventListener("click",r)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=/^#[\wа-яА-ЯёЁ]{1,19}$/,n=window.nodes.imgEditingFormComment.maxLength,o=[{value:"none",name:"none"},{value:"chrome",name:"grayscale",min:0,max:1,measure:""},{value:"sepia",name:"sepia",min:0,max:1,measure:""},{value:"marvin",name:"invert",min:0,max:100,measure:"%"},{value:"phobos",name:"blur",min:0,max:3,measure:"px"},{value:"heat",name:"brightness",min:1,max:3,measure:""}],i=window.nodes.imgEditingForm.querySelectorAll(".effects__preview"),d=document.querySelector(".img-upload__preview"),r=document.querySelector(".scale__control--smaller"),s=document.querySelector(".scale__control--bigger"),l=document.querySelector(".scale__control--value"),a=e=>(l.value=100*e+"%",d.querySelector("img").style.transform=`scale(${e})`,e);let c=a(1);const m=e=>{let t=0;e.target===r&&c>.25?t=-.25:e.target===s&&c<1&&(t=.25),c=a(c+t),r.disabled=.25===c,s.disabled=1===c},u=document.querySelector(".img-upload__effect-level"),w=u.querySelector(".effect-level__value"),g=u.querySelector(".effect-level__line"),v=g.querySelector(".effect-level__depth");let p=o[0];const E=e=>100*e+"%",y=()=>window.nodes.filterSliderControl.getBoundingClientRect().x-g.getBoundingClientRect().x+window.nodes.filterSliderControl.getBoundingClientRect().width/2,f=e=>{v.style.width=E(e),w.value=Math.round(100*e),d.querySelector("img").style.filter=((e,t)=>`${e.name}(${t*(e.max-e.min)+e.min+e.measure})`)(p,e)},L=()=>{if(p.name===o[0].name)return u.classList.add("hidden"),void(d.querySelector("img").style.filter="");u.classList.remove("hidden"),window.nodes.filterSliderControl.style.left=E(1),f(1)};L(),window.nodes.imgEditingForm.addEventListener("change",(e=>{e.target&&e.target.matches('input[type="radio"]')&&o.forEach((t=>{t.value===e.target.value&&(p=t,L())}))}));const h=()=>{window.nodes.textHashtagsInput.style.outline="none";let e=window.nodes.textHashtagsInput.value.split(" ");if(e.length>5)window.nodes.textHashtagsInput.setCustomValidity("Максимальное количество хэш-тегов: 5");else if((e=>{for(let t=0;t<e.length;t++)if(e[t]=e[t].toLowerCase(),e.indexOf(e[t])!==t)return!0;return!1})(e))window.nodes.textHashtagsInput.setCustomValidity("Хэш-теги не должны повторяться и не чувствительны к регистру");else{window.nodes.textHashtagsInput.setCustomValidity("");for(let n=0;n<e.length&&!t.test(e[n])&&""!==e[n];n++){if(e[n].length<2||e[n].length>20){window.nodes.textHashtagsInput.setCustomValidity("Длина хэш-тегов должна быть не менее 2 и не более 20 символов");break}window.nodes.textHashtagsInput.setCustomValidity("Хэш-тэг начинается с символа # и может содержать только буквы и числа")}}window.nodes.textHashtagsInput.reportValidity()};window.nodes.textHashtagsInput.addEventListener("focus",(()=>{window.nodes.textHashtagsInput.addEventListener("input",h)})),window.nodes.textHashtagsInput.addEventListener("blur",(()=>{window.nodes.textHashtagsInput.removeEventListener("input",h)}));const S=()=>{window.nodes.imgEditingFormComment.style.outline="none",window.nodes.imgEditingFormComment.value.length>n&&window.nodes.imgEditingFormComment.setCustomValidity(`Длина комментария не может быть больше ${n} символов`),window.nodes.imgEditingFormComment.reportValidity()};window.nodes.imgEditingFormComment.addEventListener("focus",(()=>{window.nodes.imgEditingFormComment.addEventListener("input",S)})),window.nodes.imgEditingFormComment.addEventListener("blur",(()=>{window.nodes.imgEditingFormComment.removeEventListener("input",S)})),window.form={onMouseDown:e=>{e.preventDefault();let t=e.clientX,n={left:t-y(),right:t+(g.getBoundingClientRect().width-y())};const o=e=>{e.preventDefault();let o=e.clientX;o<n.left&&(o=n.left),o>n.right&&(o=n.right);let i=t-o;window.nodes.filterSliderControl.style.left=window.nodes.filterSliderControl.offsetLeft-i+"px",t=o,f(y()/g.getBoundingClientRect().width)},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)},clearEditing:()=>{p=o[0],L(),window.nodes.textHashtagsInput.value="",window.nodes.imgEditingFormComment.value="",window.nodes.uploadFileInput.value="",window.nodes.imgEditingForm.querySelector(".effects__radio").checked=!0},clearScale:()=>{c=a(1),s.disabled=!0,r.focus()},onPreviewScaleControlsClick:e=>{m(e)},onPreviewScaleControlsEnterPress:e=>{window.utils.isEnterEvent(e,(()=>{m(e)}))},changePreview:()=>{let t=window.nodes.imgEditingForm.querySelector("img").src,n=window.nodes.uploadFileInput.files[0],o=n.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{t=e.result,window.nodes.imgEditingForm.querySelector("img").src=t,i.forEach((e=>{e.style.backgroundImage=`url('${t}')`}))})),e.readAsDataURL(n)}}}})(),(()=>{const e="success",t="error";let n=[],o=[];const i=[{name:"default",filter:()=>n,repeat:!1},{name:"random",filter:()=>window.utils.getRandomizedArray(n).slice(0,10),repeat:!0},{name:"discussed",filter:()=>n.slice().sort(((e,t)=>t.comments.length-e.comments.length)),repeat:!1}],d=window.nodes.imgEditingForm.querySelector(".img-upload__overlay"),r=window.nodes.imgEditingForm.querySelector("#upload-cancel"),s=window.nodes.imgEditingForm.querySelector(".img-upload__submit"),l=e=>{window.utils.isEscEvent(e,w)},a=e=>{e.validity.valid||(e.style.outline="5px solid red")},c=()=>{a(window.nodes.textHashtagsInput),a(window.nodes.imgEditingFormComment)},m=e=>{e.target!==s&&window.utils.isEnterEvent(e)},u=e=>{window.backend.save(new FormData(window.nodes.imgEditingForm),F,x),e.preventDefault()},w=()=>{window.nodes.body.classList.remove("modal-open"),d.classList.add("hidden"),document.removeEventListener("keydown",l),document.removeEventListener("keydown",m),window.nodes.picturesList.addEventListener("click",f),window.nodes.filterSliderControl.removeEventListener("mousedown",window.form.onMouseDown),s.removeEventListener("click",c),window.nodes.imgEditingForm.removeEventListener("submit",u),window.form.clearEditing(),window.nodes.imgEditingForm.removeEventListener("click",window.form.onPreviewScaleControlsClick),window.nodes.imgEditingForm.removeEventListener("keydown",window.form.onPreviewScaleControlsEnterPress)};window.nodes.uploadFileInput.addEventListener("change",(()=>{window.nodes.picturesList.removeEventListener("click",f),window.nodes.body.classList.add("modal-open"),d.classList.remove("hidden"),window.form.changePreview(),window.form.clearScale(),document.addEventListener("keydown",l),document.addEventListener("keydown",m),window.nodes.filterSliderControl.addEventListener("mousedown",window.form.onMouseDown),s.addEventListener("click",c),window.nodes.imgEditingForm.addEventListener("submit",u),window.nodes.imgEditingForm.addEventListener("click",window.form.onPreviewScaleControlsClick),window.nodes.imgEditingForm.addEventListener("keydown",window.form.onPreviewScaleControlsEnterPress)})),r.addEventListener("click",(()=>{w()})),r.addEventListener("keydown",(e=>{window.utils.isEnterEvent(e,w)})),window.nodes.textHashtagsInput.addEventListener("focus",(()=>{document.removeEventListener("keydown",l)})),window.nodes.textHashtagsInput.addEventListener("blur",(()=>{document.addEventListener("keydown",l)})),window.nodes.imgEditingFormComment.addEventListener("focus",(()=>{document.removeEventListener("keydown",l)})),window.nodes.imgEditingFormComment.addEventListener("blur",(()=>{document.addEventListener("keydown",l)}));const g=document.querySelector(".img-filters"),v=g.querySelector(".img-filters__form"),p={default:v.querySelector("#filter-default"),random:v.querySelector("#filter-random"),discussed:v.querySelector("#filter-discussed")};let E=i[0];const y=window.utils.debounce((e=>{window.picture.updateGallery(e)}));v.addEventListener("click",(e=>{let t=i[0];for(let n=0;n<i.length;n++)if(e.target===p[i[n].name]){t=i[n];break}var n;(E!==(n=t)||E.repeat)&&(E!==n&&(p[E.name].classList.remove("img-filters__button--active"),p[n.name].classList.add("img-filters__button--active"),E=n),o=n.filter(),y(o))}));const f=e=>{let t=e.target.closest(".picture");if(t){if(o.length>0)return void window.preview.openBigPicture(o[t.dataset.imgNumber]);window.preview.openBigPicture(n[t.dataset.imgNumber])}},L=document.querySelector("main"),h={error:document.querySelector("#error").content.querySelector(".error"),success:document.querySelector("#success").content.querySelector(".success")};let S="",_="";const k=()=>{_.removeEventListener("click",k),document.removeEventListener("keydown",C),document.removeEventListener("click",q),window.nodes.body.classList.remove("modal-open"),window.nodes.picturesList.addEventListener("click",f),S.remove()},C=e=>{window.utils.isEscEvent(e,k)},q=e=>{e.target===S&&k()},b=(e,t)=>{let n=h[e].cloneNode(!0);L.insertAdjacentElement("afterbegin",n),window.nodes.body.classList.add("modal-open"),window.nodes.picturesList.removeEventListener("click",f),S=document.querySelector("."+e),_=S.querySelector(`.${e}__button`),_.focus(),t?(n.querySelector(".error__title").textContent="Не удалось загрузить фотографии",_.textContent="Понятно"):w(),_.addEventListener("click",k),document.addEventListener("keydown",C),document.addEventListener("click",q)},x=()=>{b(t)},F=()=>{b(e)};window.gallery={loadSuccessHandler:e=>{n=e,window.picture.updateGallery(n),g.classList.remove("img-filters--inactive"),window.nodes.picturesList.addEventListener("click",f)},loadErrorHandler:()=>{b(t,!0)}}})(),window.backend.load(window.gallery.loadSuccessHandler,window.gallery.loadErrorHandler)})();